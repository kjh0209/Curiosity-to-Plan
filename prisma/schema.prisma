// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                String     @id @default(cuid())
  email             String     @unique
  password          String
  name              String?
  interest          String     @default("")
  goal              String     @default("")
  minutesPerDay     Int        @default(20)
  totalDays         Int        @default(14)
  riskStyle         String     @default("BALANCED") // CONSERVATIVE | BALANCED | CHALLENGER
  baselineLevel     String     @default("BEGINNER") // BEGINNER | INTERMEDIATE | ADVANCED
  variant           String     @default("ADAPTIVE") // STATIC | ADAPTIVE
  language          String     @default("en") // en | ko | ja | zh | es | ...
  resourceSort      String     @default("relevance") // relevance | viewCount | rating
  streak            Int        @default(0)
  freezeCount       Int        @default(0)
  lastCompletedDate DateTime?
  
  // API Key Management
  openaiApiKey      String?    // Encrypted user's own OpenAI API key
  openaiModel       String     @default("gpt-4o-mini") // gpt-4o-mini | gpt-4o | gpt-3.5-turbo
  
  // Token Management (Monthly)
  openaiMonthlyTokenLimit Int  @default(2000000) // Default ~2M tokens ($0.30 for mini)
  openaiTokenUsagePeriod  Int  @default(0)       // Usage in current period
  openaiPeriodStart       DateTime @default(now()) // Start of current billing period
  openaiUsageToday        Int  @default(0)       // Keep for backward compat/daily tracking

  // Gemini API
  geminiApiKey      String?    
  geminiModel       String     @default("gemini-2.0-flash")
  geminiMonthlyTokenLimit Int  @default(5000000) // Higher limit for free tier
  geminiTokenUsagePeriod  Int  @default(0)
  geminiPeriodStart       DateTime @default(now())
  geminiUsageToday        Int  @default(0)
  
  lastUsageReset    DateTime   @default(now()) 
  
  createdAt         DateTime   @default(now())
  plans             Plan[]
  quizAttempts      QuizAttempt[]
}

model Plan {
  id              String     @id @default(cuid())
  userId          String
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  planTitle       String
  totalDays       Int        @default(14)
  minutesPerDay   Int        @default(20)
  language        String     @default("en")  // Language the plan was created in
  skillGraph      String?    // JSON stringified skill graph
  recommendedBook String?    // JSON: { title, author, totalPages, amazonUrl?, description }
  createdAt       DateTime   @default(now())
  days            DayPlan[]
  quizAttempts    QuizAttempt[]
}

model DayPlan {
  id           String   @id @default(cuid())
  planId       String
  plan         Plan     @relation(fields: [planId], references: [id], onDelete: Cascade)
  dayNumber    Int
  missionTitle String
  focus        String
  difficulty   Int      @default(1)
  status       String   @default("LOCKED") // LOCKED | READY | DONE
  recommendedBook String? // JSON: { title, author, reason }
  steps        String?  // JSON stringified array
  quiz         String?  // JSON stringified array
  resources    String?  // JSON array of {type, title, url, description, duration?}
  result       String?  // JSON stringified grade result
  
  // AI Content Caching (Language-aware)
  // Format: { "en": { ...data... }, "ko": { ...data... } }
  slides       String?  // JSON cache of generated slides per language
  article      String?  // JSON cache of generated article per language
  
  // Time Management
  estimatedMinutes Int      @default(20)  // AI-estimated time
  actualMinutes    Int?                    // User's actual time spent
  startedAt        DateTime?               // When user started learning
  completedAt      DateTime?               // When user completed
  
  feedbacks    UserFeedback[]
  
  @@unique([planId, dayNumber])
}

model QuizAttempt {
  id               String   @id @default(cuid())
  userId           String
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  planId           String
  plan             Plan     @relation(fields: [planId], references: [id], onDelete: Cascade)
  dayNumber        Int
  answers          String   // JSON stringified user answers
  score            Float    // 0.0 - 1.0
  feedback         String
  difficultySignal String   // TOO_EASY | ON_TRACK | TOO_HARD
  createdAt        DateTime @default(now())
}

model TraceLog {
  id        String   @id @default(cuid())
  traceId   String
  traceName String
  userId    String?
  metadata  String?  // JSON
  createdAt DateTime @default(now())
}

model UserFeedback {
  id               String   @id @default(cuid())
  userId           String
  dayPlanId        String?
  dayPlan          DayPlan? @relation(fields: [dayPlanId], references: [id], onDelete: Cascade)
  contentRating    Int      // 1-5: Content quality
  difficultyRating Int      // 1-5: Appropriateness of difficulty
  resourceRating   Int      // 1-5: Resource usefulness
  textFeedback     String?  // Free text feedback
  createdAt        DateTime @default(now())
}
